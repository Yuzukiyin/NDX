# NDX 认证系统说明

## 📊 数据库位置和同步

### Railway上的数据库
- **位置**: Railway容器内的 `/app/ndx_users.db`
- **持久化**: Railway使用**卷(Volume)**持久化数据库文件
- **访问方式**: 通过Railway CLI连接: `railway run sqlite3 ndx_users.db`

### 本地开发数据库
- **位置**: `Web/backend/ndx_users.db`
- **独立性**: 与Railway数据库**完全独立**,不会自动同步
- **用途**: 仅用于本地开发测试

### ⚠️ 重要说明
1. **Railway和本地数据库是分开的**
   - Railway部署的数据库有admin用户 (1712008344@qq.com)
   - 本地数据库是空的,需要手动注册用户或运行初始化脚本

2. **所有生产数据都在Railway上**
   - 你通过Vercel前端登录的数据全部存储在Railway的数据库
   - 本地数据库只影响本地开发(localhost:8000)

3. **数据不会丢失**
   - Railway使用持久卷,重启容器数据不会丢失
   - 只要不删除Railway项目,数据永久保存

## 🔐 Refresh Tokens 表的作用

### 功能说明
`refresh_tokens` 表用于实现**长期登录**功能,避免用户频繁输入密码。

### 工作流程
1. **登录时**
   - 用户输入邮箱和密码
   - 后端验证成功后,生成两个token:
     - `access_token`: 短期令牌(30分钟),用于API请求
     - `refresh_token`: 长期令牌(7天),存储在数据库

2. **Access Token过期后**
   - 前端检测到401错误
   - 自动使用`refresh_token`请求新的`access_token`
   - 无需用户重新登录

3. **Refresh Token过期后**
   - 7天后需要重新登录
   - 旧的refresh_token从数据库删除

### 表结构
```sql
CREATE TABLE refresh_tokens (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,        -- 关联的用户ID
    token TEXT UNIQUE NOT NULL,      -- 加密的refresh token
    expires_at DATETIME NOT NULL,    -- 过期时间(7天后)
    created_at DATETIME DEFAULT NOW
);
```

### 安全特性
- 每个用户可以有多个refresh_token(多设备登录)
- Token存储在httpOnly cookie,JS无法访问,防止XSS攻击
- 过期token自动失效并从数据库清除

## 📝 当前状态总结

### Railway数据库状态 ✅
- **Users表**: 已有1个admin用户
  - Email: 1712008344@qq.com
  - Username: admin
  - Password: Lzy171200 (环境变量设置)
  - Status: Active + Verified

- **Refresh_tokens表**: 初始为空
  - 登录后会自动创建记录
  
- **Transactions表**: 空(等待导入数据)

- **Fund_overview表**: 空

### Railway环境变量 ✅
当前配置完全正确,不需要修改:
- `ADMIN_EMAIL=1712008344@qq.com`
- `ADMIN_PASSWORD=Lzy171200`
- `ADMIN_USERNAME=admin`
- `DATABASE_URL=sqlite:///./ndx_users.db`
- `SECRET_KEY=4VnffDWpzXa1TNIJSy3_KpaIhNUAVq8q4iooGHyBh_4`

**CORS_ORIGINS环境变量可以删除**,因为代码已经使用正则匹配所有Vercel域名。

### Vercel域名变化说明
- 旧域名 `https://ndx-khaki.vercel.app` 消失是正常的
- Vercel每次部署会创建新的预览域名(如`ndx-5ymfcxnqn...`)
- 稳定域名是 `https://ndx-git-main-yuzukiyins-projects.vercel.app`
- 所有Vercel域名现在都通过正则 `https://.*\.vercel\.app` 自动允许

## 🚀 下一步操作

1. **等待Railway重新部署** (1-2分钟)
   - 最新的CORS修复会生效
   
2. **测试登录**
   - 访问: https://ndx-git-main-yuzukiyins-projects.vercel.app/login
   - 邮箱: 1712008344@qq.com
   - 密码: Lzy171200

3. **导入基金数据**
   - 登录成功后,需要从本地的`fund.db`导入transactions到Railway

4. **本地开发(可选)**
   - 本地后端启动后,访问 http://localhost:8000/auth/register 注册测试账号
   - 或运行 `python init_admin.py` 创建本地admin用户
