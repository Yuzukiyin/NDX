# 功能修复说明

## ✅ 已修复的功能

### 1. 抓取历史净值功能 ✅ 正常工作

**API**: `POST /funds/fetch-nav`

**工作流程**:
1. 从数据库 `auto_invest_plans` 表读取当前用户启用的定投计划
2. 获取每个基金的历史净值数据(从东方财富API)
3. 将净值数据写入 `fund_nav_history` 表
4. 返回详细的抓取结果

**特点**:
- ✅ 自动从数据库读取定投计划(不再依赖JSON文件)
- ✅ 只抓取缺失的净值日期(避免重复)
- ✅ 如果数据库已有该日期净值则跳过
- ✅ 返回详细统计(成功数/总数/写入行数)

**示例返回**:
```json
{
  "message": "抓取完成: 成功 3/3 个基金，共导入 150 条记录",
  "success": true,
  "total_plans": 3,
  "success_count": 3,
  "total_rows_written": 150,
  "details": [...]
}
```

---

### 2. 定投计划执行功能 ✅ 已修复

**API**: `POST /auto-invest/execute-today`

**修复前问题**:
- ❌ 只执行今天的定投计划
- ❌ 如果今天不符合频率条件(如月度计划但今天不是定投日)则不执行
- ❌ 无法补齐历史缺失的记录

**修复后行为**:
- ✅ **从定投开始日期到今天,补齐所有缺失的记录**
- ✅ 根据定投频率(daily/weekly/monthly/quarterly)生成所有应该定投的日期
- ✅ 自动跳过周末
- ✅ 检查数据库是否已存在记录,避免重复
- ✅ 为每条记录计算T+1确认日期

**工作流程**:
```
1. 读取启用的定投计划
   ↓
2. 遍历每个计划
   ↓
3. 根据频率生成从start_date到today的所有定投日期
   (daily: 每天, weekly: 每周, monthly: 每月, quarterly: 每季度)
   ↓
4. 过滤掉周末
   ↓
5. 检查每个日期是否已有交易记录
   ↓
6. 创建缺失的[待确认]交易记录
   ↓
7. 返回统计结果
```

**示例**:
假设有一个定投计划:
- 基金: 021000
- 频率: monthly (每月)
- 开始: 2024-01-15
- 结束: 2025-12-31

执行后会创建:
- 2024-01-15 [待确认]
- 2024-02-15 [待确认]
- 2024-03-15 [待确认]
- ...
- 2025-12-15 [待确认] (或到今天为止)

**示例返回**:
```json
{
  "message": "定投计划执行完成: 新建 23 条记录, 跳过已存在 12 条",
  "transactions_created": 23,
  "skipped": 12,
  "date": "2025-12-03"
}
```

---

## 📋 完整使用流程

### 场景1: 新用户创建定投计划

1. **创建定投计划**
   ```
   网页 → 定投 → 新增计划
   - 基金代码: 021000
   - 频率: monthly
   - 开始日期: 2024-01-15
   - 结束日期: 2025-12-31
   ```

2. **执行定投计划** (补齐所有缺失记录)
   ```
   调用 POST /auto-invest/execute-today
   → 创建从2024-01-15到今天的所有月度记录
   ```

3. **抓取历史净值**
   ```
   网页 → 工具 → 抓取历史净值
   → 抓取021000从成立日到今天的净值数据
   ```

4. **更新待确认交易**
   ```
   网页 → 工具 → 更新待确认交易
   → 自动填充份额和净值
   ```

5. **查看基金概览**
   ```
   网页 → 基金
   → 显示持仓、收益等信息
   ```

---

## 🔧 技术改进

### 修改的文件:
1. **`app/routes/auto_invest.py`**
   - 添加 `from dateutil.relativedelta import relativedelta`
   - 修改 `execute_today_plans` 函数逻辑
   - 增加日期生成循环
   - 增加已存在记录检查

### 核心代码改进:
```python
# 修复前: 只检查今天
should_execute = (today_dt.weekday() == start_date.weekday())

# 修复后: 生成所有日期
plan_dates = []
current_date = start_date
while current_date <= end_date:
    if current_date.weekday() < 5:  # 跳过周末
        plan_dates.append(current_date)
    
    if plan.frequency == 'daily':
        current_date += timedelta(days=1)
    elif plan.frequency == 'monthly':
        current_date += relativedelta(months=1)
    # ...
```

---

## ✅ 验证清单

- [x] 抓取历史净值从数据库读取定投计划
- [x] 抓取历史净值写入fund_nav_history表
- [x] 抓取历史净值返回详细结果
- [x] 定投计划执行补齐所有缺失记录
- [x] 定投计划执行根据频率生成日期
- [x] 定投计划执行跳过周末
- [x] 定投计划执行避免重复记录
- [x] 定投计划执行计算T+1确认日期
- [x] 多用户数据隔离
- [x] 代码无语法错误

---

## 🎯 结论

两个功能现在都能正常工作:

1. **抓取历史净值**: ✅ 从数据库定投计划读取,抓取并写入净值数据
2. **执行定投计划**: ✅ 从开始日期到今天补齐所有缺失的记录

用户可以放心使用!
