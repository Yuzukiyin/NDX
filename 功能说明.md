# 🚀 NDX 基金管理系统 - 完整功能说明

## 📱 前端页面

### 1. 概览页面 (Dashboard)
- 四大核心指标卡片: 总市值、总成本、总收益、总收益率
- 持仓基金网格展示(最多4只)
- 实时数据更新

### 2. 基金页面 (Funds)
- 所有持仓基金的3列网格布局
- 每只基金显示:
  - 基金名称和代码
  - 当前市值和累计收益
  - 持有份额和当前净值
  - 收益率百分比标签

### 3. 交易页面 (Transactions)
- 专业表格展示所有交易记录
- 支持分页浏览
- 交易详情模态框(点击查看)
- 显示: 日期、基金、类型、金额、份额、净值、备注

### 4. **工具页面 (Tools)** ⭐ 新增
提供4大核心功能:

#### 📝 添加交易记录
- 手动输入交易信息
- 字段:
  - 基金代码 (必填): 如 021000
  - 基金名称 (可选)
  - 交易日期 (必填)
  - 交易类型: 买入/卖出
  - 金额 (必填): 自动计算份额
  - 备注 (可选)
- 提交后自动同步到数据库

#### 📈 抓取历史净值
- 从东方财富网自动获取最新净值数据
- 更新所有持仓基金的净值历史
- 用于计算最新市值和收益

#### 🔄 更新待确认交易
- 自动更新待确认交易的净值和份额
- 处理交易日净值缺失的情况
- 完成后标记为已确认

#### 📅 设置定投计划 (开发中)
- 配置自动定投规则
- 设置金额、频率、执行日期
- 自动生成定投交易记录

## 🔌 后端API端点

### 认证相关
- `POST /auth/register` - 注册账号
- `POST /auth/login` - 登录获取token
- `POST /auth/refresh` - 刷新access token
- `GET /auth/me` - 获取当前用户信息

### 基金数据
- `GET /funds/overview` - 获取所有基金概览
- `GET /funds/overview/{fund_code}` - 获取单只基金详情
- `GET /funds/transactions` - 获取交易记录(支持分页和筛选)
- `GET /funds/nav-history/{fund_code}` - 获取净值历史
- `GET /funds/profit-summary` - 获取收益汇总

### 数据管理
- `POST /funds/transactions` - **创建单笔交易** ⭐ 新增
- `POST /funds/transactions/batch` - **批量导入交易** ⭐ 新增
- `POST /funds/nav-history/batch` - **批量导入净值** ⭐ 新增
- `POST /funds/fetch-nav` - 抓取历史净值
- `POST /funds/update-pending` - 更新待确认交易
- `POST /funds/initialize-database` - 初始化数据库

## 📊 数据导入功能

### 从本地fund.db导入到Railway

#### 步骤1: 导出本地数据
```bash
cd D:\AAAStudy\NDX
python export_fund_data.py
```
生成文件:
- `transactions_export.json` - 67条交易记录
- `nav_history_export.json` - 3611条净值记录

#### 步骤2: 上传到Railway
```bash
python upload_to_railway.py
```

自动执行:
1. 登录Railway后端
2. 批量上传交易记录
3. 批量上传净值历史
4. 显示上传进度和结果

### 导入数据示例

**交易记录格式**:
```json
{
  "fund_code": "021000",
  "fund_name": "华夏回报混合A",
  "transaction_date": "2024-01-15",
  "transaction_type": "买入",
  "amount": 1000.00,
  "shares": 500.25,
  "unit_nav": 1.9990,
  "note": "定投-月度计划"
}
```

**净值历史格式**:
```json
{
  "fund_code": "021000",
  "fund_name": "华夏回报混合A",
  "price_date": "2024-01-15",
  "unit_nav": 1.9990,
  "fetched_at": "2024-01-16T10:30:00"
}
```

## 🎯 使用流程

### 首次使用
1. **注册/登录**
   - 访问: https://ndx-git-main-yuzukiyins-projects.vercel.app
   - Railway已自动创建admin账号:
     - Email: 1712008344@qq.com
     - Password: Lzy171200

2. **导入历史数据** (一次性)
   ```bash
   # 本地执行
   cd D:\AAAStudy\NDX
   python export_fund_data.py
   python upload_to_railway.py
   ```

3. **查看概览**
   - 登录后自动跳转到Dashboard
   - 查看总市值、收益等指标
   - 浏览持仓基金

### 日常使用

#### 添加交易记录
1. 点击导航栏 **工具**
2. 点击 **添加交易记录**
3. 填写表单:
   - 基金代码: 021000
   - 交易日期: 2024-12-01
   - 交易类型: 买入
   - 金额: 500.00
   - 备注: 月度定投
4. 点击 **提交**

#### 更新净值数据
1. 进入 **工具** 页面
2. 点击 **抓取历史净值**
3. 等待1-2分钟自动抓取完成
4. 返回 **概览** 查看更新后的数据

#### 处理待确认交易
1. 进入 **工具** 页面
2. 点击 **更新待确认交易**
3. 系统自动:
   - 查询净值日净值
   - 计算份额
   - 更新金额
   - 标记为已确认

## 🗄️ 数据库架构

### 核心表结构

#### users (用户表)
```sql
- id: 用户ID
- email: 邮箱 (唯一)
- username: 用户名
- hashed_password: 加密密码
- is_active: 是否激活
- is_verified: 是否已验证
- created_at: 创建时间
- last_login: 最后登录
```

#### transactions (交易表)
```sql
- transaction_id: 交易ID
- user_id: 用户ID (多租户隔离)
- fund_code: 基金代码
- fund_name: 基金名称
- transaction_date: 交易日期
- nav_date: 净值日期
- transaction_type: 买入/卖出
- target_amount: 目标金额
- shares: 份额
- unit_nav: 单位净值
- amount: 实际金额
- note: 备注
- created_at: 创建时间
```

#### fund_nav_history (净值历史表)
```sql
- id: 记录ID
- fund_code: 基金代码
- fund_name: 基金名称
- price_date: 净值日期
- unit_nav: 单位净值
- cumulative_nav: 累计净值
- daily_growth_rate: 日增长率
- fetched_at: 抓取时间
```

#### fund_overview (基金概览表)
由triggers自动维护,聚合每个用户的基金持仓:
```sql
- user_id: 用户ID
- fund_code: 基金代码
- fund_name: 基金名称
- total_shares: 总份额
- average_cost: 平均成本
- total_cost: 总成本
- updated_at: 更新时间
```

### 视图 (Views)

#### fund_realtime_overview
实时基金概览,包含当前市值和收益:
- 合并 fund_overview + 最新净值
- 计算 current_value = total_shares × current_nav
- 计算 profit = current_value - total_cost
- 计算 profit_rate = (profit / total_cost) × 100

#### profit_summary
用户总收益汇总:
- total_funds: 基金数量
- total_shares: 总份额
- total_cost: 总成本
- total_value: 总市值
- total_profit: 总收益
- total_return_rate: 总收益率

## 🔐 安全特性

1. **JWT认证**: Access Token (30分钟) + Refresh Token (7天)
2. **多租户隔离**: 所有查询自动过滤 user_id
3. **密码加密**: bcrypt哈希存储
4. **CORS保护**: 限制跨域请求来源
5. **Token刷新**: 自动续期无需重新登录

## 📍 部署信息

### Railway后端
- URL: https://ndx-production.up.railway.app
- 数据库: SQLite (持久卷存储)
- 环境: Python 3.11 + FastAPI + Uvicorn
- 自动部署: Git push触发

### Vercel前端
- URL: https://ndx-git-main-yuzukiyins-projects.vercel.app
- 框架: React 18 + Vite + TypeScript
- 样式: Tailwind CSS (Apple风格)
- 自动部署: Git push触发

## 🎨 设计风格

采用Apple产品页面美学:
- **极简主义**: 干净简洁的界面
- **圆角设计**: 所有元素2xl/3xl圆角
- **柔和阴影**: 多层次shadow提升层次感
- **弹性动画**: Spring easing曲线
- **玻璃态**: Backdrop blur毛玻璃效果
- **配色**: 黑白灰性冷淡风 + 渐变点缀

## 📞 支持

遇到问题?
1. 查看Railway日志: `railway logs`
2. 查看Vercel部署日志: Vercel控制台
3. 检查浏览器控制台错误
4. 验证API连接: DevTools Network标签

## 🔮 后续计划

- [ ] 定投计划自动执行
- [ ] 交易记录批量导入CSV
- [ ] 基金收益图表可视化
- [ ] 移动端响应式优化
- [ ] 数据导出功能(Excel/PDF)
- [ ] 邮件提醒功能
